#!/bin/bash

# ====================================================================================================
# ffmpeg を使ってカレントディレクトリ配下の全動画ファイルを圧縮するバッチ (Git SDK での利用を想定)
# ====================================================================================================
echo "---------- $(date --iso-8601=seconds) ----- Start"

# TODO : カレントディレクトリ配下のファイルを `./` など付けずに指定した場合のみ考慮している。入力ファイル名・出力ファイル名はもう少し柔軟に制御できると嬉しい
# `-loglevel quiet` と `-loglevel error` はほぼ同じ。`-stats` を付ければ進捗が出る
# `-progress -` 指定で進捗が出るが要らないか。所要時間を測りたいなら `time` の方が分かりやすい
function encode_video() {
  local output="_$1.mp4"
  ffmpeg -hide_banner -loglevel quiet -stats  -hwaccel cuda  -i "$1"  -c:v h264_nvenc -vf scale=-1:480 -b:v 0.8M  "$output"
}

# ls -1 の結果を改行ごとに処理するため IFS を変更しておく
ORIGINAL_IFS=$IFS
IFS=$'\n'

# ls -1 で上手く表示できているか見ておく。ファイル名が長すぎるとダメ
# for 部分の `$(ls -1)` はダブルクォートで囲んではダメ。バッククォートは同じ
for input in $(ls -1); do
  echo "---------- $(date --iso-8601=seconds) ----- ${input} Start"
  encode_video "${input}"
  echo "========== $(date --iso-8601=seconds) ===== ${input} Finished"
done

# 終了
IFS=$ORIGINAL_IFS
echo "========== $(date --iso-8601=seconds) ===== Finished"
